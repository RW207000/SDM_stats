---
title: "Stats"
author: "R.Welch"
date: "2025-03-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

libraries
```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor")

lapply(packages, library, character.only = TRUE)
```

Want to achieve:
- combine Nov23-Nov24 with Nov24-Feb25 (because Nov24-Feb25 only has 10 data points)
- total daily standarised doses for each medication
- flag HC daily dose <8mg and >20mg per BSA
- add n number to stats
- performs stats on all other numerical fields from minimal dataset (e.g.: height,         weight, BMI, renin, testosterone, glucose, BPs)
- look at dose timings, per centre per drug
- 17 ohp and andro lab values women vs men per centre
- HC dose trends per centre (including individual doses and total daily doses)
- blood pressure - spread of values for both diastolic vs systolic and subsequent        categories

I have processed data in excel for now, so I'll start by reading that in here to use as a starting point for this analysis.


```{r : reading in data}
Nov22_Nov23_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov22-Nov23.csv", header=T, na.strings= c("", "NA"))

Nov23_Nov24_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov23-Nov24.csv", header=T, na.strings= c("", "NA"))

Nov24_Feb25_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Feb25-Nov24.csv", header=T, na.strings= c("", "NA"))
```


Let's merge Nov23-Nov24 to Nov24-Feb25
```{r : making Nov23-Feb25}
Nov23_Feb25_minimal_dataset <- rbind(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# remove the two now individual frames

remove(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)
```

Let's format date fields properly
```{r : formatting date fields}
Nov22_Nov23_minimal_dataset$Date.of.Assessment <- as.Date(Nov22_Nov23_minimal_dataset$Date.of.Assessment, format = "%d/%m/%Y")

Nov23_Feb25_minimal_dataset$Date.of.Assessment <- as.Date(Nov23_Feb25_minimal_dataset$Date.of.Assessment, format = "%d/%m/%Y")
```

```{r : patient stats}
# Let's look at how many patients are assessed by each centre - note that this is different from the number of patients recruited (because not every patient has necessarily been assessed). If a patient has NOT been assessed then there will be NO ENTRY into SDM registry for that patient, therefore they are, for all intents and purposes, non-existent in this analysis since there is no record of them.

patients_per_centre_Nov22_Nov23 <- Nov22_Nov23_minimal_dataset %>%
  group_by(Centre.ID.x) %>%
  summarise("number of patients assessed 22-23" = n_unique(CO.ID.x))

patients_per_centre_Nov23_Feb25 <- Nov23_Feb25_minimal_dataset %>%
  group_by(Centre.ID.x) %>%
  summarise("number of patients assessed 23-25" = n_unique(CO.ID.x))  

# Now join these two data frames together so all visit info is in one frame

patients_per_centre <- full_join(patients_per_centre_Nov22_Nov23, patients_per_centre_Nov23_Feb25, by = "Centre.ID.x")
```

```{r : removing values of 0 from data frames}
# I'm doing this because values of 0 indicates data required for previous arithmetic (done in excel) is missing.

Nov22_Nov23_minimal_dataset[Nov22_Nov23_minimal_dataset <=0] <- NA
Nov23_Feb25_minimal_dataset[Nov23_Feb25_minimal_dataset <=0] <- NA
```


--- Statistical analysis ---
I'm doing this one time frame at a time :)

Let's start with stats for Nov22-Nov23

```{r : height (22-23)}
# Let's do height
stats_Nov22_Nov23_height <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean" = mean(Nov22_Nov23_minimal_dataset$Height..cm., na.rm = T),
            "median" = median(Nov22_Nov23_minimal_dataset$Height..cm., na.rm = T),
            "SD" = sd(Nov22_Nov23_minimal_dataset$Height..cm., na.rm = T),
            "min" = min(Nov22_Nov23_minimal_dataset$Height..cm., na.rm = T),
            "max" = max(Nov22_Nov23_minimal_dataset$Height..cm., na.rm = T),
            "n" = length(Nov22_Nov23_minimal_dataset$Height..cm.[!is.na(Nov22_Nov23_minimal_dataset$Height..cm.)])) %>%
  mutate_if(is.numeric, ~round(., 2))

## change shape of data frame
stat_frame_Nov22_Nov23 <- data.frame(cbind(names(stats_Nov22_Nov23_height), t(stats_Nov22_Nov23_height)))
stat_frame_Nov22_Nov23 <- select(stat_frame_Nov22_Nov23, -X1)
colnames(stat_frame_Nov22_Nov23) <- c("Height (cm)")


# join height to main stat frame
stat_frame_Nov22_Nov23$"Height (cm)" <- stat_frame_Nov22_Nov23$"Height (cm)"
```

```{r : weight (22-23)}
# Now for weight
stats_Nov22_Nov23_weight <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean" = mean(Nov22_Nov23_minimal_dataset$Weight..kg., na.rm = T),
            "median" = median(Nov22_Nov23_minimal_dataset$Weight..kg., na.rm = T),
            "SD" = sd(Nov22_Nov23_minimal_dataset$Weight..kg., na.rm = T),
            "min" = min(Nov22_Nov23_minimal_dataset$Weight..kg., na.rm = T),
            "max" = max(Nov22_Nov23_minimal_dataset$Weight..kg., na.rm = T),
            "n" = length(Nov22_Nov23_minimal_dataset$Weight..kg.[!is.na(Nov22_Nov23_minimal_dataset$Weight..kg.)])) %>%
  mutate_if(is.numeric, ~round(., 2))

## change shape of data frame
stat_frame_Nov22_Nov23_weight <- data.frame(cbind(names(stats_Nov22_Nov23_weight), t(stats_Nov22_Nov23_weight)))
stat_frame_Nov22_Nov23_weight <- select(stat_frame_Nov22_Nov23_weight, -X1)
colnames(stat_frame_Nov22_Nov23_weight) <- c("Weight (kg)")


# join height to main stat frame
stat_frame_Nov22_Nov23$"Weight (kg)" <- stat_frame_Nov22_Nov23_weight$"Weight (kg)"
```

```{r : BMI (22-23)}
# Now for BMI
stats_Nov22_Nov23_BMI <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean" = mean(Nov22_Nov23_minimal_dataset$BMI, na.rm = T),
            "median" = median(Nov22_Nov23_minimal_dataset$BMI, na.rm = T),
            "SD" = sd(Nov22_Nov23_minimal_dataset$BMI, na.rm = T),
            "min" = min(Nov22_Nov23_minimal_dataset$BMI, na.rm = T),
            "max" = max(Nov22_Nov23_minimal_dataset$BMI, na.rm = T),
            "n" = length(Nov22_Nov23_minimal_dataset$BMI[!is.na(Nov22_Nov23_minimal_dataset$BMI)])) %>%
  mutate_if(is.numeric, ~round(., 2))

## change shape of data frame
stats_Nov22_Nov23_BMI <- data.frame(cbind(names(stats_Nov22_Nov23_BMI), t(stats_Nov22_Nov23_BMI)))
stats_Nov22_Nov23_BMI <- select(stats_Nov22_Nov23_BMI, -X1)
colnames(stats_Nov22_Nov23_BMI) <- c("Weight (kg)")


# join height to main stat frame
stat_frame_Nov22_Nov23$BMI <- stats_Nov22_Nov23_BMI$`Weight (kg)`
```

```{r : total_standardised_daily_dose_per_BSA (22-23)}
stats_Nov22_Nov23_dose_per_BSA <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean" = mean(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "median" = median(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "SD" = sd(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "min" = min(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "max" = max(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "n" = length(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA[!is.na(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA)])) %>%
  mutate_if(is.numeric, ~round(., 2))

## change shape of data frame
stat_frame_Nov22_Nov23_BSA <- data.frame(cbind(names(stats_Nov22_Nov23_dose_per_BSA), t(stats_Nov22_Nov23_dose_per_BSA)))
stat_frame_Nov22_Nov23_BSA <- select(stat_frame_Nov22_Nov23_BSA, -X1)
colnames(stat_frame_Nov22_Nov23_BSA) <- c("total standardised daily dose per BSA (mg)")

# join per BSA to main stat frame
stat_frame_Nov22_Nov23$"total standardised daily dose per BSA" <- stat_frame_Nov22_Nov23_BSA$"total standardised daily dose per BSA (mg)"
```

```{r : total_standardised_daily_dose_per_kg (22-23)}
# Now for total_standardised_daily_dose_per_kg

stats_Nov22_Nov23_dose_per_kg <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean" = mean(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg, na.rm = T),
            "median" = median(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg, na.rm = T),
            "SD" = sd(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg, na.rm = T),
            "min" = min(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg, na.rm = T),
            "max" = max(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg, na.rm = T),
            "n" = length(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg[!is.na(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_kg)])) %>%
  mutate_if(is.numeric, ~round(., 2))

## change shape of data frame
stat_frame_Nov22_Nov23_kg <- data.frame(cbind(names(stats_Nov22_Nov23_dose_per_kg), t(stats_Nov22_Nov23_dose_per_kg)))
stat_frame_Nov22_Nov23_kg <- select(stat_frame_Nov22_Nov23_kg, -X1)
colnames(stat_frame_Nov22_Nov23_kg) <- c("total standardised daily dose per kg (mg)")


# join per kg to main stat frame
stat_frame_Nov22_Nov23$"total standardised daily dose per kg (mg)" <- stat_frame_Nov22_Nov23_kg$`total standardised daily dose per kg (mg)`
```


############################
```{r}

summariseStat <- function(statName, minimalDataset) {

colNames <- names(minimalDataset)
nameIdx <- colNames == statName

if (sum(nameIdx) == 0) {
  print(sum(nameIdx))
  print("no variable with that name")
  return (FALSE)
}

stat = as.vector(minimalDataset[,nameIdx])

StatSummary <- minimalDataset %>%
  summarise("mean" = mean(stat, na.rm = T),
            "median" = median(stat, na.rm = T),
            "SD" = sd(stat, na.rm = T),
            "min" = min(stat, na.rm = T),
            "max" = max(stat, na.rm = T),
            "n" = length(stat[!is.na(stat)])) %>%
  mutate_if(is.numeric, ~round(., 2))

print(StatSummary)

## change shape of data frame
statSummaryFrame <- data.frame(cbind(names(StatSummary), t(StatSummary)))
statSummaryFrame <- select(statSummaryFrame, -X1)
colnames(statSummaryFrame) <- c(statName)

return (statSummaryFrame)

}
```





how to use Oscar's function

BMI <- summariseStat("BMI", df)


```{r : joining stat frames}
# StatFrame <- cbind(X, Y)
```

############################








