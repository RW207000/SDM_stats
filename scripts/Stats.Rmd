---
title: "Stats"
author: "R.Welch"
date: "2025-03-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

libraries
```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor")

lapply(packages, library, character.only = TRUE)
```

Want to achieve:
- combine Nov23-Nov24 with Nov24-Feb25 (because Nov24-Feb25 only has 10 data points)
- total daily standarised doses for each medication
- flag HC daily dose <8mg and >20mg per BSA
- add n number to stats
- performs stats on all other numerical fields from minimal dataset (e.g.: height,         weight, BMI, renin, testosterone, glucose, BPs)
- look at dose timings, per centre per drug
- 17 ohp and andro lab values women vs men per centre
- HC dose trends per centre (including individual doses and total daily doses)
- blood pressure - spread of values for both diastolic vs systolic and subsequent        categories

I have processed data in excel for now, so I'll start by reading that in here to use as a starting point for this analysis.


```{r : reading in data}
Nov22_Nov23_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov22-Nov23.csv", header=T, na.strings= c("", "NA"))

Nov23_Nov24_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov23-Nov24.csv", header=T, na.strings= c("", "NA"))

Nov24_Feb25_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Feb25-Nov24.csv", header=T, na.strings= c("", "NA"))
```


Let's merge Nov23-Nov24 to Nov24-Feb25
```{r : making Nov23-Feb25}
Nov23_Feb25_minimal_dataset <- rbind(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# remove the two now individual frames

remove(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)
```

Let's format date fields properly
```{r : formatting date fields}
Nov22_Nov23_minimal_dataset$Date.of.Assessment <- as.Date(Nov22_Nov23_minimal_dataset$Date.of.Assessment, format = "%d/%m/%Y")

Nov23_Feb25_minimal_dataset$Date.of.Assessment <- as.Date(Nov23_Feb25_minimal_dataset$Date.of.Assessment, format = "%d/%m/%Y")
```

```{r : patient stats}
# Let's look at how many patients are assessed by each centre - note that this is different from the number of patients recruited (because not every patient has necessarily been assessed). If a patient has NOT been assessed then there will be NO ENTRY into SDM registry for that patient, therefore they are, for all intents and purposes, non-existent in this analysis since there is no record of them.

patients_per_centre_Nov22_Nov23 <- Nov22_Nov23_minimal_dataset %>%
  group_by(Centre.ID.x) %>%
  summarise("number of patients assessed 22-23" = n_unique(CO.ID.x))

patients_per_centre_Nov23_Feb25 <- Nov23_Feb25_minimal_dataset %>%
  group_by(Centre.ID.x) %>%
  summarise("number of patients assessed 23-25" = n_unique(CO.ID.x))  

# Now join these two data frames together so all visit info is in one frame

patients_per_centre <- full_join(patients_per_centre_Nov22_Nov23, patients_per_centre_Nov23_Feb25, by = "Centre.ID.x")
```

```{r : removing values of 0 from data frames}
# I'm doing this because values of 0 indicates data required for previous arithmetic (done in excel) is missing.

Nov22_Nov23_minimal_dataset[Nov22_Nov23_minimal_dataset <=0] <- NA
Nov23_Feb25_minimal_dataset[Nov23_Feb25_minimal_dataset <=0] <- NA
```


--- Statistical analysis ---
Let's start with stats for total_standardised_daily_dose_per_BSA
```{r : stats - total_standardised_daily_dose_per_BSA}
# First for Nov22-Nov23

stats_Nov22_Nov23_dose_per_BSA <- Nov22_Nov23_minimal_dataset %>%
  summarise("mean daily dose per BSA (22-23)" = mean(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "median daily dose per BSA (22-23)" = median(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "SD daily dose per BSA (22-23)" = sd(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "min daily dose per BSA (22-23)" = min(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "max daily dose per BSA (22-23)" = max(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "n (22-23)" = length(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA[!is.na(Nov22_Nov23_minimal_dataset$total_standardised_daily_dose_per_BSA)])) %>%
  mutate_if(is.numeric, ~round(., 1))

# Then for Nov23-Feb25

stats_Nov23_Feb25_dose_per_BSA <- Nov23_Feb25_minimal_dataset %>%
  summarise("mean daily dose per BSA (23-25)" = mean(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "median daily dose per BSA (23-25)" = median(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "SD daily dose per BSA (23-25)" = sd(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "min daily dose per BSA (23-25)" = min(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "max daily dose per BSA (23-25)" = max(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA, na.rm = T),
            "n (23-25)" = length(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA[!is.na(Nov23_Feb25_minimal_dataset$total_standardised_daily_dose_per_BSA)])) %>%
  mutate_if(is.numeric, ~round(., 1))
```

Now let's do total_standardised_daily_dose_per_kg
```{r: stats - total_standardised_daily_dose_per_kg}


```









