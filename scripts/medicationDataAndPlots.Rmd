---
title: "medicationDataAndPlots"
author: "R.Welch"
date: "2025-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
libraries
```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor", "ggbreak", "patchwork", "plotrix", "viridis", "hrbrthemes", "showtext")

lapply(packages, library, character.only = TRUE)
```

```{r : set up #2}
# read in data
Nov22_Nov23_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov22-Nov23.csv", header=T, na.strings= c("", "NA"))

Nov23_Nov24_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov23-Nov24.csv", header=T, na.strings= c("", "NA"))

Nov24_Feb25_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Feb25-Nov24.csv", header=T, na.strings= c("", "NA"))

# making Nov23-Feb25
Nov23_Feb25_minimal_dataset <- rbind(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# remove the two now individual frames
remove(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# format type of columns correctly
Nov23_Feb25_minimal_dataset$HC_equivalent_daily_dose_per_BSA <- as.numeric(Nov23_Feb25_minimal_dataset$HC_equivalent_daily_dose_per_BSA)

Nov23_Feb25_minimal_dataset$HC_equivalent_daily_dose_per_kg <- as.numeric(Nov23_Feb25_minimal_dataset$HC_equivalent_daily_dose_per_kg)

Nov23_Feb25_minimal_dataset$Date.y <- as.Date(Nov23_Feb25_minimal_dataset$Date.y, format = "%d/%m/%Y")


# given that stats here will often be split by sex, NK says to remove the single 'Not Assigned' (add note of this patient's data) to make plots easier to read. They're in the Nov23-Feb25 dataframe
# extract this patient's data into its own frame before removing it
NA_patient <- subset(Nov23_Feb25_minimal_dataset, Nov23_Feb25_minimal_dataset$Sex.at.birth.x == "Not Assigned")

Nov23_Feb25_minimal_dataset <- Nov23_Feb25_minimal_dataset [!Nov23_Feb25_minimal_dataset$Sex.at.birth.x == "Not Assigned",]

# colours
myColours <- c("purple", "lightblue", "grey")

# histogram colours
histColours <- c("red", "springgreen2", "royalblue2")
```

```{r : split therapy types}
# let's make a new frame to determine which patients are on single or combined therapies:
therapy_22_23 <- Nov22_Nov23_minimal_dataset

# need to add in column for dose_time_hours_4 for 22-23 data set
therapy_22_23$dose_time_hours_4 <- NA

  #select(Nov22_Nov23_minimal_dataset, c("Centre.ID.x", "Sex.at.birth.x", "CO.ID.x",  "Medicine_1.x", "Dose_1", "Standardised.doses_1", "Medicine_2.x", "Dose_2", "Standardised.doses_2", "Medicine_3.x", "Dose_3", "Standardised.doses_3", "Medicine_4.x", "Dose_4", "Standardised.doses_4", "HC_equivalent_daily_dose_1_1"))

therapy_23_25 <- Nov23_Feb25_minimal_dataset
  #select(Nov23_Feb25_minimal_dataset, c("Centre.ID.x", "Sex.at.birth.x", "CO.ID.x", "Medicine_1.x", "Dose_1", "Standardised.doses_1", "Medicine_2.x", "Dose_2", "Standardised.doses_2", "Medicine_3.x", "Dose_3", "Standardised.doses_3", "Medicine_4.x", "Dose_4", "Standardised.doses_4", "HC_equivalent_daily_dose_1_1"))

# need to add in column for dose_time_hours_4 for 23-25 data set
therapy_23_25$dose_time_hours_4 <- NA

therapy_22_23$Total_raw_dose <- rowSums(therapy_22_23 [,c("Dose_1", "Dose_2", "Dose_3", "Dose_4")], na.rm =TRUE)

therapy_23_25$Total_raw_dose <- rowSums(therapy_23_25 [,c("Dose_1", "Dose_2", "Dose_3", "Dose_4")], na.rm =TRUE)



# remove rows with NO MEDICATION DATA
therapy_22_23 <- therapy_22_23 [!is.na(therapy_22_23$Medicine_1.x),]
therapy_23_25 <- therapy_23_25 [!is.na(therapy_23_25$Medicine_1.x),]

therapy_22_23$"single/combined" <- NA
therapy_23_25$"single/combined" <- NA

# check for single vs combined
therapy_22_23$`single/combined` <-
  ifelse(!is.na(therapy_22_23$Medicine_1.x) &
         (is.na(therapy_22_23$Medicine_2.x) & is.na(therapy_22_23$Medicine_3.x) & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & is.na(therapy_22_23$Medicine_3.x) & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_3.x & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_3.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_4.x),
          as.character("single"),
          as.character("combined"))


therapy_23_25$`single/combined` <-
  ifelse(!is.na(therapy_23_25$Medicine_1.x) &
         (is.na(therapy_23_25$Medicine_2.x) & is.na(therapy_23_25$Medicine_3.x) & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & is.na(therapy_23_25$Medicine_3.x) & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_3.x & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_3.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_4.x),
          as.character("single"),
          as.character("combined"))

therapy_22_23_single <- therapy_22_23[therapy_22_23$`single/combined` == "single",]
therapy_23_25_single <- therapy_23_25[therapy_23_25$`single/combined` == "single",]

therapy_22_23_combined <- therapy_22_23[therapy_22_23$`single/combined` == "combined",] 
therapy_23_25_combined <- therapy_23_25[therapy_23_25$`single/combined` == "combined",]
```

```{r : med box plots raw values}
# using MDBoxPlot function

DexamethasoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Dexamethasone",], "Total_raw_dose", "None", "total dose dexamethasone 22-23")

DexamethasoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Dexamethasone",], "Total_raw_dose", "None", "total dose dexamethasone 23-25")

EfmodyBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Efmody",], "Total_raw_dose", "None", "total dose efmody 22-23")

EfmodyBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Efmody",], "Total_raw_dose", "None", "total dose efmody 23-25")

HydrocortisoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Hydrocortisone",], "Total_raw_dose", "None", "total dose hydro 22-23")

HydrocortisoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Hydrocortisone",], "Total_raw_dose", "None", "total dose hydro 23-25")

PrednisoloneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Prednisolone",], "Total_raw_dose", "None", "total dose prednisolone 22-23")

PrednisoloneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Prednisolone",], "Total_raw_dose", "None", "total dose prednisolone 23-25")
```

```{r : med box plots HC equivalent}
# using MDBoxPlot function
# don't need to do HC here since this is the medicine to which the others have been standardised.
# also don't need to do Efmody since this is already equivalent.

equiv_DexamethasoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Dexamethasone",], "HC_equivalent_daily_dose_1_1", "None", "HC equivalent dose dexamethasone 22-23")

equiv_DexamethasoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Dexamethasone",], "HC_equivalent_daily_dose_1_1", "None", "HC equivalent dose dexamethasone 23-25")

equiv_PrednisoloneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Prednisolone",], "HC_equivalent_daily_dose_1_1", "None", "HC equivalent dose prednisolone 22-23")

equiv_PrednisoloneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Prednisolone",], "HC_equivalent_daily_dose_1_1", "None", "HC equivalent dose prednisolone 23-25")
```

```{r : med box plots dose per BSA values}
# using MDBoxPlot function

HC_equiv_BSA_DexamethasoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Dexamethasone",], "HC_equivalent_daily_dose_per_BSA", "None", "HC equiv per BSA dose dexamethasone 22-23")

HC_equiv_BSA_DexamethasoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Dexamethasone",], "HC_equivalent_daily_dose_per_BSA", "None", "HC equiv per BSA dose dexamethasone 23-25")

HC_equiv_BSA_EfmodyBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Efmody",], "HC_equivalent_daily_dose_per_BSA", "None", "HC equiv per BSA dose efmody 22-23")

HC_equiv_BSA_EfmodyBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Efmody",], "HC_equivalent_daily_dose_per_BSA", "None", "HC equiv per BSA dose efmody 23-25")

HC_equiv_BSA_HydrocortisoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Hydrocortisone",], "HC_equivalent_daily_dose_per_BSA", "SBS", "HC per BSA dose hydro 22-23")

HC_equiv_BSA_HydrocortisoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Hydrocortisone",], "HC_equivalent_daily_dose_per_BSA", "None", "HC per BSA dose hydro 23-25")

HC_equiv_BSA_PrednisoloneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Prednisolone",], "HC_equivalent_daily_dose_per_BSA", "NTEO", "HC equiv per BSA dose prednisolone 22-23")

HC_equiv_BSA_PrednisoloneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Prednisolone",], "HC_equivalent_daily_dose_per_BSA", "None", "HC equiv per BSA dose prednisolone 23-25")
```


```{r : dose time histograms}
# using medTimePlot function
# this is for all data across all centres

Dex_dose_times_22_23 <- medTimePlot(therapy_22_23_single, "Dexamethasone", "Dexamethasone dose timing (22-23)")

Dex_dose_times_23_25 <- medTimePlot(therapy_23_25_single, "Dexamethasone", "Dexamethasone dose timing (23-25)")

Efmody_dose_times_22_23 <- medTimePlot(therapy_22_23_single, "Efmody", "Efmody dose timing (22-23)")

Efmody_dose_times_23_25 <- medTimePlot(therapy_23_25_single, "Efmody", "Efmody dose timing (23-25)")

HC_dose_times_22_23 <- medTimePlot(therapy_22_23_single, "Hydrocortisone", "HC dose timing (22-23)")

HC_dose_times_23_25 <- medTimePlot(therapy_23_25_single, "Hydrocortisone", "HC dose timing (23-25)")

Pred_dose_times_22_23 <- medTimePlot(therapy_22_23_single, "Prednisolone", "Pred dose timing (22-23)")

Pred_dose_times_23_25 <- medTimePlot(therapy_23_25_single, "Prednisolone", "Pred dose timing (23-35)")
```

```{r : raw dose stats}
raw_HC_doses_22_23 <- summariseMed(therapy_22_23_single, "Hydrocortisone", "raw")

raw_HC_doses_23_25 <- summariseMed(therapy_23_25_single, "Hydrocortisone", "raw")

raw_pred_doses_22_23 <- summariseMed(therapy_22_23_single, "Prednisolone", "raw")

raw_pred_doses_23_25 <- summariseMed(therapy_23_25_single, "Prednisolone", "raw")

raw_efmody_doses_22_23 <- summariseMed(therapy_22_23_single, "Efmody", "raw")

raw_efmody_doses_23_25 <- summariseMed(therapy_23_25_single, "Efmody", "raw")

raw_dex_doses_22_23 <- summariseMed(therapy_22_23_single, "Dexamethasone", "raw")

raw_dex_doses_23_25 <- summariseMed(therapy_23_25_single, "Dexamethasone", "raw")
```

```{r : HC equivalent dose stats}
equiv_pred_doses_22_23 <- summariseMed(therapy_22_23_single, "Prednisolone", "equiv")

equiv_pred_doses_23_25 <- summariseMed(therapy_23_25_single, "Prednisolone", "equiv")

equiv_dex_doses_22_23 <- summariseMed(therapy_22_23_single, "Dexamethasone", "equiv")

equiv_dex_doses_23_25 <- summariseMed(therapy_23_25_single, "Dexamethasone", "equiv")
```

```{r : HC equivalent per BSA dose stats}
# error to fix
equiv_BSA_pred_doses_22_23 <- summariseMed(therapy_22_23_single, "Prednisolone", "BSA")

equiv_BSA_pred_doses_23_25 <- summariseMed(therapy_23_25_single, "Prednisolone", "BSA")

equiv_BSA_dex_doses_22_23 <- summariseMed(therapy_22_23_single, "Dexamethasone", "BSA")

equiv_BSA_dex_doses_23_25 <- summariseMed(therapy_23_25_single, "Dexamethasone", "BSA")
```



```{r : therapy dose trends}
therapy_dose_trends_22_23 <- ggplot(therapy_22_23_single, aes(x = Centre.ID.x, y = HC_equivalent_daily_dose_1_1, fill = Medicine_1.x)) +
  geom_boxplot(position = position_dodge2(preserve='single'),
                   ) +
  ggtitle("therapy dose trends 22-23") +
  theme_minimal() +
  geom_point(position = position_dodge(width = 0.75))

therapy_dose_trends_23_25 <- ggplot(therapy_23_25_single, aes(x = Centre.ID.x, y = HC_equivalent_daily_dose_1_1, fill = Medicine_1.x)) +
  geom_boxplot(position = position_dodge2(preserve='single'),
                   ) +
  ggtitle("therapy dose trends 23-25") +
  theme_minimal() +
  geom_point(position = position_dodge(width = 0.75))
```


```{r : therapy dose trends with facet wrap}
therapy_dose_trends_22_23 <- ggplot(therapy_22_23_single, aes(x = Centre.ID.x, y = HC_equivalent_daily_dose_1_1, fill = Medicine_1.x)) +
  geom_boxplot() +
  ggtitle("therapy dose trends 22-23") +
  facet_wrap(~ Medicine_1.x, axes = "all", axis.labels = "all") +
  theme_minimal() +
  geom_point(position = position_dodge(width = 0.75))

therapy_dose_trends_23_25 <- ggplot(therapy_23_25_single, aes(x = Centre.ID.x, y = HC_equivalent_daily_dose_1_1, fill = Medicine_1.x)) +
  geom_boxplot() +
  ggtitle("therapy dose trends 23-25") +
  facet_wrap(~ Medicine_1.x, axes = "all", axis.labels = "all") +
  theme_minimal() +
  geom_point(position = position_dodge(width = 0.75))
```

```{r}


```

```{r : script completion message}
print("Script complete")

```