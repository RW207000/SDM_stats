---
title: "medicationDataAndPlots"
author: "R.Welch"
date: "2025-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
libraries
```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor", "ggbreak", "patchwork", "plotrix", "viridis", "hrbrthemes")

lapply(packages, library, character.only = TRUE)
```

```{r : set up #2}
# read in data
Nov22_Nov23_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov22-Nov23.csv", header=T, na.strings= c("", "NA"))

Nov23_Nov24_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Nov23-Nov24.csv", header=T, na.strings= c("", "NA"))

Nov24_Feb25_minimal_dataset <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/SDM_stats/data/Feb25-Nov24.csv", header=T, na.strings= c("", "NA"))

# making Nov23-Feb25
Nov23_Feb25_minimal_dataset <- rbind(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# remove the two now individual frames
remove(Nov23_Nov24_minimal_dataset, Nov24_Feb25_minimal_dataset)

# given that stats here will often be split by sex, NK says to remove the single 'Not Assigned' (add note of this patient's data) to make plots easier to read. They're in the Nov23-Feb25 dataframe
# extract this patient's data into its own frame before removing it
NA_patient <- subset(Nov23_Feb25_minimal_dataset, Nov23_Feb25_minimal_dataset$Sex.at.birth.x == "Not Assigned")

Nov23_Feb25_minimal_dataset <- Nov23_Feb25_minimal_dataset [!Nov23_Feb25_minimal_dataset$Sex.at.birth.x == "Not Assigned",]

# colours
myColours <- c("purple", "lightblue", "grey")
```

```{r : split therapy types}
# let's make a new frame to determine which patients are on single or combined therapies:
therapy_22_23 <- Nov22_Nov23_minimal_dataset

# need to add in column for dose_time_hours_4 for 22-23 data set
therapy_22_23$dose_time_hours_4 <- NA

  #select(Nov22_Nov23_minimal_dataset, c("Centre.ID.x", "Sex.at.birth.x", "CO.ID.x",  "Medicine_1.x", "Dose_1", "Standardised.doses_1", "Medicine_2.x", "Dose_2", "Standardised.doses_2", "Medicine_3.x", "Dose_3", "Standardised.doses_3", "Medicine_4.x", "Dose_4", "Standardised.doses_4", "total_standardised_daily_dose_1_1"))

therapy_23_25 <- Nov23_Feb25_minimal_dataset
  #select(Nov23_Feb25_minimal_dataset, c("Centre.ID.x", "Sex.at.birth.x", "CO.ID.x", "Medicine_1.x", "Dose_1", "Standardised.doses_1", "Medicine_2.x", "Dose_2", "Standardised.doses_2", "Medicine_3.x", "Dose_3", "Standardised.doses_3", "Medicine_4.x", "Dose_4", "Standardised.doses_4", "total_standardised_daily_dose_1_1"))

# need to add in column for dose_time_hours_4 for 23-25 data set
therapy_23_25$dose_time_hours_4 <- NA

therapy_22_23$Total_raw_dose <- rowSums(therapy_22_23 [,c("Dose_1", "Dose_2", "Dose_3", "Dose_4")], na.rm =TRUE)

therapy_23_25$Total_raw_dose <- rowSums(therapy_23_25 [,c("Dose_1", "Dose_2", "Dose_3", "Dose_4")], na.rm =TRUE)



# remove rows with NO MEDICATION DATA
therapy_22_23 <- therapy_22_23 [!is.na(therapy_22_23$Medicine_1.x),]
therapy_23_25 <- therapy_23_25 [!is.na(therapy_23_25$Medicine_1.x),]

therapy_22_23$"single/combined" <- NA
therapy_23_25$"single/combined" <- NA

# check for single vs combined
therapy_22_23$`single/combined` <-
  ifelse(!is.na(therapy_22_23$Medicine_1.x) &
         (is.na(therapy_22_23$Medicine_2.x) & is.na(therapy_22_23$Medicine_3.x) & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & is.na(therapy_22_23$Medicine_3.x) & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_3.x & is.na(therapy_22_23$Medicine_4.x) |
          therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_2.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_3.x & therapy_22_23$Medicine_1.x == therapy_22_23$Medicine_4.x),
          as.character("single"),
          as.character("combined"))


therapy_23_25$`single/combined` <-
  ifelse(!is.na(therapy_23_25$Medicine_1.x) &
         (is.na(therapy_23_25$Medicine_2.x) & is.na(therapy_23_25$Medicine_3.x) & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & is.na(therapy_23_25$Medicine_3.x) & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_3.x & is.na(therapy_23_25$Medicine_4.x) |
          therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_2.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_3.x & therapy_23_25$Medicine_1.x == therapy_23_25$Medicine_4.x),
          as.character("single"),
          as.character("combined"))

therapy_22_23_single = therapy_22_23[therapy_22_23$`single/combined` == "single",]
therapy_23_25_single = therapy_23_25[therapy_23_25$`single/combined` == "single",]

```

```{r : make plots with raw doses 22-23}
# for 22-23, raw dose values

HydrocortisoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Hydrocortisone",], "Total_raw_dose", "None", "total dose hydro 22-23")

PrednisoloneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Prednisolone",], "Total_raw_dose", "None", "total dose prednisolone 22-23") + ylim(0, 10)

EfmodyBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Efmody",], "Total_raw_dose", "None", "total dose efmody 22-23")

DexamethasoneBoxPlot_22_23 <- MDBoxPlot(therapy_22_23_single[therapy_22_23_single$Medicine_1.x == "Dexamethasone",], "Total_raw_dose", "None", "total dose dexamethasone 22-23")

```

```{r : make plots with raw doses 23-25}
# for 23-25, raw dose values

HydrocortisoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Hydrocortisone",], "Total_raw_dose", "None", "total dose hydro 23-25")

PrednisoloneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Prednisolone",], "Total_raw_dose", "None", "total dose") + ylim(0, 10)

EfmodyBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Efmody",], "Total_raw_dose", "None", "total dose")

DexamethasoneBoxPlot_23_25 <- MDBoxPlot(therapy_23_25_single[therapy_23_25_single$Medicine_1.x == "Dexamethasone",], "Total_raw_dose", "None", "total dose")

```


```{r : make stats}



```


```{r : dose time histograms}

# need to pivot data to make histogram with multiple dose time data on it

timings_long_set_up <- therapy_22_23_single %>%
  pivot_longer(cols = c(dose_time_hours_1, dose_time_hours_2, dose_time_hours_3, dose_time_hours_4),
               names_to = c("dose_number"),
               values_to = "time")

timings_long <- timings_long_set_up[, c("dose_number", "time", "Medicine_1.x", "Medicine_2.x", "Medicine_3.x", "Medicine_4.x")]

HC_dose_times <- timings_long %>%
  filter(timings_long$Medicine_1.x == "Hydrocortisone") %>%
  ggplot(aes(x = time, fill = dose_number)) +
  geom_histogram()


```



p <- data %>%
  ggplot( aes(x=value, fill=type)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    theme_ipsum() +
    labs(fill="")
